# This workflow pushes the PR build to quay.io
name: Publish PR

on:
  pull_request:

env:
  TAG: PR-${{ github.event.number }}

jobs:
  jib-push:
    # Don't run for forks and dependabot because of missing secrets
    if: "!(github.event.pull_request && github.event.pull_request.head.repo.fork) && github.actor != 'dependabot[bot]'"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd #v6.0.2

      - name: Set up Java
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          distribution: 'temurin'
          java-version: 21
          cache: 'gradle'

      - name: Build and Push
        env:
          USERNAME: ${{ secrets.QUAY_IO_USERNAME }}
          PASSWORD: ${{ secrets.QUAY_IO_PASSWORD }}
        run: >
          ./gradlew jib
          -Djib.to.auth.username=${USERNAME}
          -Djib.to.auth.password=${PASSWORD}
          -Djib.useOnlyProjectCache=true
          -Djib.console=plain
          -Djib.disableUpdateChecks=true
          -Djib.httpTimeout=0
          -Djib.container.creationTime=USE_CURRENT_TIMESTAMP
          -Djib.to.image=quay.io/sdase/mongodb-operator:${TAG}
